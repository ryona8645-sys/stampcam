<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>StampCam (å¤§ããªæ’®å½±ç”»é¢ / ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆUI / è‡ªå‹•ä¿å­˜å¯¾å¿œ)</title>
<style>
  :root{--sa-b:env(safe-area-inset-bottom,0px);--sa-l:env(safe-area-inset-left,0px);--sa-r:env(safe-area-inset-right,0px)}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{font-family:sans-serif;background:#000;color:#fff}

  /* æ’®å½±ç”»é¢ã‚’æœ€å¤§åŒ– */
  #stage{position:fixed;inset:0;padding:0}
  #v{
    position:absolute;inset:0;margin:auto;max-width:100%;max-height:100%;
    width:100%;height:100%;object-fit:contain;background:#000;
  }

  /* å·¦å³ãƒˆã‚°ãƒ«ï¼ˆæ©Ÿå™¨/ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ */
  .toggle{
    position:fixed;top:50%;transform:translateY(-50%);z-index:35;
    display:flex;align-items:center;justify-content:center;width:34px;height:96px;border-radius:10px;
    background:rgba(0,0,0,.55);color:#fff;border:1px solid rgba(255,255,255,.25);
    writing-mode:vertical-rl;text-orientation:mixed;font-size:12px;letter-spacing:.5px;
    user-select:none;-webkit-user-select:none
  }
  .l-toggle{left:4px}
  .r-toggle{right:4px}

  /* å·¦ãƒ‰ãƒ­ãƒ¯ï¼ˆæ©Ÿå™¨é¸æŠï¼‰ */
  .ldrawer{
    position:fixed;top:0;left:0;height:100dvh;width:min(80vw,520px);z-index:40;
    transform:translateX(calc(-100% + 12px));transition:transform .25s ease;
    display:flex;flex-direction:column;background:#111;color:#fff;border-right:1px solid rgba(255,255,255,.1);
    box-shadow:8px 0 20px rgba(0,0,0,.25)
  }
  .ldrawer.open{transform:translateX(0)}
  .ld-header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;background:#1b1b1b}
  .ld-body{padding:12px;display:flex;flex-direction:column;gap:10px;overflow:auto;flex:1}
  .input-row{display:flex;gap:8px;align-items:center}
  .input-row input[type=text]{flex:1;min-width:140px;padding:10px;border:1px solid #666;border-radius:10px;background:#000;color:#fff}
  .legend{font-size:12px;color:#bbb}
  .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
  .grid button{
    width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;background:#fff;color:#000;
    transition:transform .05s ease, box-shadow .15s ease; font-variant-numeric:tabular-nums;
  }
  .grid button:active{transform:scale(.97)}
  .grid button.on{box-shadow:0 0 0 3px #ffd400 inset}
  .grid button.shot{background:#0a66c2;color:#fff;border-color:#0a66c2}
  .grid button.shot.on{box-shadow:0 0 0 3px #ffd400, inset 0 0 0 2px rgba(0,0,0,.12)}
  .grid button.label-dash{background:#eee}

  /* å³ãƒ‰ãƒ­ãƒ¯ï¼ˆç›´å‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ */
  .rdrawer{
    position:fixed;top:0;right:0;height:100dvh;width:min(70vw,480px);z-index:40;
    transform:translateX(calc(100% - 12px));transition:transform .25s ease;
    display:flex;flex-direction:column;background:#111;color:#fff;border-left:1px solid rgba(255,255,255,.1);
    box-shadow:-8px 0 20px rgba(0,0,0,.25)
  }
  .rdrawer.open{transform:translateX(0)}
  .rd-header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;background:#1b1b1b}
  .rd-body{flex:1;overflow:hidden;position:relative}
  #lastShot{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(1);
    transform-origin:center center;max-width:100%;max-height:100%;background:#000;border-radius:8px;touch-action:none
  }
  .pinch-hint{
    position:absolute;left:0;right:0;bottom:8px;text-align:center;font-size:12px;color:#eee;
    background:linear-gradient(180deg,transparent,rgba(0,0,0,.55));padding:8px 4px
  }

  .close-btn{background:#333;color:#fff;border:1px solid #666;border-radius:8px;padding:6px 10px;font-size:12px}

  /* ===== ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆæ“ä½œUIï¼ˆç”»é¢ä¸Šã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ ===== */
  .ctrls{
    position:fixed;left:0;right:0;bottom:calc(10px + var(--sa-b));z-index:45;
    display:flex;justify-content:center;gap:10px;pointer-events:none;
  }
  .ctrls .btn{
    pointer-events:auto;border:none;border-radius:999px;background:rgba(255,255,255,.9);color:#000;
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 3px 12px rgba(0,0,0,.35)
  }
  #shootBtn{width:82px;height:82px; font-weight:bold; border:4px solid #e33; background:#fff}
  #torchBtn,#resBtn,#zoomBtn{width:48px;height:48px;font-size:14px}

  /* ã‚ºãƒ¼ãƒ ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒ */
  .zoom-pop{
    position:fixed;left:50%;bottom:calc(104px + var(--sa-b));
    transform:translateX(-50%);z-index:46;display:none;
    background:rgba(0,0,0,.65);backdrop-filter:blur(6px);
    padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.2)
  }
  .zoom-pop.show{display:block}
  .zoom-pop input[type=range]{width:min(72vw,520px);height:28px}

  /* Toast */
  .toast{
    position:fixed;left:50%;bottom:calc(160px + var(--sa-b));
    transform:translateX(-50%);padding:10px 14px;border-radius:12px;font-size:14px;color:#fff;z-index:99;
    background:#333;opacity:0;pointer-events:none;transition:opacity .2s ease;
    max-width:90vw;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,.25)
  }
  .toast.show{opacity:.96}
  .toast.ok{background:#2e7d32}
  .toast.err{background:#c62828}
</style>

<div id="stage">
  <video id="v" autoplay playsinline></video>
</div>

<!-- ç”»é¢å·¦ãƒ»å³ã®å°ã•ãªã‚¿ãƒ– -->
<div class="toggle l-toggle" id="lToggle">æ©Ÿå™¨/å…¥åŠ›</div>
<div class="toggle r-toggle" id="rToggle">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>

<!-- å·¦ãƒ‰ãƒ­ãƒ¯ï¼ˆæ©Ÿå™¨/å…¥åŠ›ï¼‰ -->
<aside id="ldrawer" class="ldrawer" aria-label="æ©Ÿå™¨é¸æŠã¨ãƒ•ã‚¡ã‚¤ãƒ«åä»˜åŠ ">
  <div class="ld-header">
    <span>ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</span>
    <button class="close-btn" id="lClose">é–‰ã˜ã‚‹</button>
  </div>
  <div class="ld-body">
    <div class="input-row">
      <input id="suffixInput" type="text" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åã«ä»˜åŠ ï¼ˆä¾‹ï¼š1F-æ±, ç›¤A, ONUå‘¨ã‚Šï¼‰">
      <button id="resetMarkBtn" class="close-btn" title="æ’®å½±æ¸ˆã¿ãƒãƒ¼ã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <div class="legend">é¸æŠ: é»„ãƒªãƒ³ã‚° / æ’®å½±æ¸ˆã¿: é’ / ã€Œ-ã€ã¯ãã®ã¾ã¾ãƒ•ã‚¡ã‚¤ãƒ«åã«</div>
    <div id="nums" class="grid"></div>
  </div>
</aside>

<!-- å³ãƒ‰ãƒ­ãƒ¯ï¼ˆç›´å‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ -->
<aside id="rdrawer" class="rdrawer" aria-label="ç›´å‰ã®å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
  <div class="rd-header">
    <span>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
    <button class="close-btn" id="rClose">é–‰ã˜ã‚‹</button>
  </div>
  <div class="rd-body">
    <img id="lastShot" alt="ç›´å‰å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" />
    <div class="pinch-hint" id="pinchHint">ãƒ”ãƒ³ãƒæ“ä½œã§æ‹¡å¤§ãƒ»ç¸®å°</div>
  </div>
</aside>

<!-- ç”»é¢ä¸Šã®ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆæ“ä½œãƒœã‚¿ãƒ³ -->
<div class="ctrls">
  <button id="torchBtn" class="btn" title="ãƒ©ã‚¤ãƒˆ">ğŸ”¦</button>
  <button id="zoomBtn" class="btn" title="ã‚ºãƒ¼ãƒ ">ğŸ”</button>
  <button id="shootBtn" class="btn" title="æ’®å½±">æ’®å½±</button>
  <button id="resBtn" class="btn" title="è§£åƒåº¦åˆ‡æ›¿">HD</button>
</div>
<div id="zoomPop" class="zoom-pop">
  <input id="zoomRange" type="range" min="1" max="1" step="0.1" value="1" disabled>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<canvas id="c" style="display:none"></canvas>
<script>
(async()=>{
  /* ===== è¦ç´ å–å¾— ===== */
  const v=document.getElementById('v'),c=document.getElementById('c'),ctx=c.getContext('2d');
  const ldrawer=document.getElementById('ldrawer'), rdrawer=document.getElementById('rdrawer'), img=document.getElementById('lastShot');
  const lToggle=document.getElementById('lToggle'), rToggle=document.getElementById('rToggle');
  const lClose=document.getElementById('lClose'), rClose=document.getElementById('rClose');
  const nums=document.getElementById('nums'), suffixInput=document.getElementById('suffixInput'), resetMarkBtn=document.getElementById('resetMarkBtn');
  const shootBtn=document.getElementById('shootBtn'), torchBtn=document.getElementById('torchBtn'), resBtn=document.getElementById('resBtn');
  const zoomBtn=document.getElementById('zoomBtn'), zoomPop=document.getElementById('zoomPop'), zoomRange=document.getElementById('zoomRange');
  const toastEl=document.getElementById('toast'), pinchHint=document.getElementById('pinchHint');

  /* ===== çŠ¶æ…‹ ===== */
  let stream=null,useHigh=false,videoTrack=null,torchOn=false;
  let currentLabel='',previewUrl=null,leftOpen=false,rightOpen=false;

  /* ===== ä¿å­˜æ–¹å¼è¨­å®š =====
     'auto'  : a[download] ã§å³DLï¼ˆå®Œäº†ã¯OSä»»ã›â†’ã€Œé–‹å§‹ã€è¡¨ç¤ºï¼‰
     'opfs'  : ãƒ–ãƒ©ã‚¦ã‚¶å°‚ç”¨é ˜åŸŸã¸å®Œå…¨è‡ªå‹•ä¿å­˜ï¼ˆã€Œå®Œäº†ã€ï¼‰
     'picker': ä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆã€Œå®Œäº†ã€ï¼‰ */
  const SAVE_MODE='auto';

  /* ===== ãƒˆãƒ¼ã‚¹ãƒˆ ===== */
  let toastTimer=null;
  function toast(msg,type='ok'){
    toastEl.textContent=msg;
    toastEl.className='toast show '+(type==='err'?'err':'ok');
    clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>toastEl.classList.remove('show'),2000);
  }

  /* ===== æ©Ÿå™¨ãƒœã‚¿ãƒ³ "-" + 1..99 ===== */
  const dashBtn=document.createElement('button');
  dashBtn.textContent='-'; dashBtn.classList.add('label-dash'); dashBtn.dataset.label='-';
  dashBtn.onclick=()=>setLabel('-'); nums.appendChild(dashBtn);
  for(let i=1;i<=99;i++){
    const b=document.createElement('button');
    b.textContent='æ©Ÿå™¨'+String(i).padStart(2,'0'); b.dataset.label='æ©Ÿå™¨'+i;
    b.onclick=()=>setLabel(b.dataset.label); nums.appendChild(b);
  }
  function setLabel(label){
    currentLabel=label;
    [...nums.children].forEach(x=>{
      const on=(x.dataset.label===label)||(!x.dataset.label && x.textContent===label);
      x.classList.toggle('on',on);
      x.setAttribute('aria-pressed',on);
    });
  }

  /* ===== ã‚«ãƒ¡ãƒ© ===== */
  async function startCamera(){
    stopStream();
    const w=useHigh?3840:1280,h=useHigh?2160:720;
    try{
      stream=await navigator.mediaDevices.getUserMedia({
        video:{facingMode:{ideal:"environment"},width:{ideal:w},height:{ideal:h}},audio:false
      });
      v.srcObject=stream;
      videoTrack=stream.getVideoTracks()[0];
      setupZoomUI(); setupTorchUI();
    }catch(e){ alert('ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: '+e); }
  }
  function stopStream(){ try{ stream && stream.getTracks().forEach(t=>t.stop()); }catch{} }
  function isStreamActive(){ return stream && stream.getTracks().some(t=>t.readyState==='live'); }
  async function ensureStreamAlive(){ if(!isStreamActive() || v.readyState<2){ await startCamera(); } }

  /* ã‚ºãƒ¼ãƒ ï¼ˆèƒ½åŠ›ã®ã‚ã‚‹ç«¯æœ«ã®ã¿ï¼‰ */
  function setupZoomUI(){
    if(!videoTrack) return;
    const caps = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
    if(caps.zoom){
      zoomRange.disabled=false;
      zoomRange.min=caps.zoom.min||1;
      zoomRange.max=caps.zoom.max||1;
      zoomRange.step=caps.zoom.step||0.1;
      const cur=(videoTrack.getSettings?.().zoom)||1;
      zoomRange.value=cur;
    }else{
      zoomRange.disabled=true;
    }
  }
  async function applyZoom(val){
    if(!videoTrack) return;
    try{ await videoTrack.applyConstraints({advanced:[{zoom:val}]}); }
    catch{ try{ await videoTrack.applyConstraints({zoom:val}); }catch{} }
  }
  zoomBtn.addEventListener('click',()=>{
    zoomPop.classList.toggle('show');
  });
  zoomRange.addEventListener('input',e=>applyZoom(Number(e.target.value)));

  /* ãƒˆãƒ¼ãƒ */
  function setupTorchUI(){
    if(!videoTrack) return;
    const caps = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
    torchBtn.disabled=!caps.torch;
    if(!caps.torch) torchBtn.title='ç«¯æœ«ãŒéå¯¾å¿œã§ã™';
  }
  async function setTorch(on){
    if(!videoTrack) return;
    try{ await videoTrack.applyConstraints({advanced:[{torch:on}]}); torchOn=on; torchBtn.style.background=on?'#ffd54f':'rgba(255,255,255,.9)'; }
    catch(e){ alert('ãƒ©ã‚¤ãƒˆåˆ‡æ›¿å¤±æ•—: '+e); }
  }
  torchBtn.addEventListener('click',()=>setTorch(!torchOn));

  /* è§£åƒåº¦ */
  resBtn.addEventListener('click',async()=>{
    useHigh=!useHigh;
    resBtn.textContent=useHigh?'4K':'HD';
    await startCamera();
  });

  /* ===== ä¿å­˜å‡¦ç† ===== */
  async function saveBlob(blob, filename){
    if(SAVE_MODE==='auto'){
      try{
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url; a.download=filename;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url),2000);
        return 'download';
      }catch(e){ throw new Error('è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—: '+e.message); }
    }
    if(SAVE_MODE==='opfs'){
      if(!(navigator.storage && navigator.storage.getDirectory)) throw new Error('OPFSæœªå¯¾å¿œ');
      const root=await navigator.storage.getDirectory();
      const handle=await root.getFileHandle(filename,{create:true});
      const w=await handle.createWritable(); await w.write(blob); await w.close();
      return 'opfs';
    }
    if(SAVE_MODE==='picker' && window.showSaveFilePicker && window.isSecureContext){
      const handle=await showSaveFilePicker({
        suggestedName: filename,
        types:[{description:'JPEG Image', accept:{'image/jpeg':['.jpg','.jpeg']}}]
      });
      const w=await handle.createWritable(); await w.write(blob); await w.close();
      return 'fs';
    }
    throw new Error('ä¿å­˜æ‰‹æ®µãªã—');
  }

  function ts(){const d=new Date(),z=n=>String(n).padStart(2,'0');return`${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}_${z(d.getHours())}-${z(d.getMinutes())}-${z(d.getSeconds())}`;}
  async function captureFrame(){
    const vw=v.videoWidth,vh=v.videoHeight; if(!vw||!vh) throw new Error('ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ä¸­ã§ã™');
    c.width=vw; c.height=vh; ctx.drawImage(v,0,0,vw,vh);
    return new Promise((r,rej)=>c.toBlob(b=>b?r(b):rej(new Error('ç”»åƒç”Ÿæˆå¤±æ•—')),'image/jpeg',0.9));
  }

  /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‹¡å¤§çŠ¶æ…‹ */
  let scale=1,lastScale=1,startDist=0,startX2=0,startY2=0,imgX=0,imgY=0,lastX=0,lastY=0,doubleTapTime=0;
  function resetPreviewTransform(){ scale=1; lastScale=1; imgX=imgY=lastX=lastY=0; updateTransform(); }
  function updateTransform(){ img.style.transform=`translate(calc(-50% + ${imgX}px),calc(-50% + ${imgY}px)) scale(${scale})`; img.style.transition='none'; }
  function getDist(e){if(e.touches.length<2)return 0;const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;return Math.sqrt(dx*dx+dy*dy);}

  img.addEventListener('touchstart',e=>{
    if(e.touches.length===1){
      const now=Date.now();
      if(now-doubleTapTime<300){scale=scale>1?1:2;imgX=imgY=0;updateTransform();return;}
      doubleTapTime=now;startX2=e.touches[0].clientX;startY2=e.touches[0].clientY;
    }else if(e.touches.length===2){startDist=getDist(e);lastScale=scale; pinchHint?.remove();}
  },{passive:true});
  img.addEventListener('touchmove',e=>{
    if(e.touches.length===1&&scale>1){
      const dx=e.touches[0].clientX-startX2,dy=e.touches[0].clientY-startY2; imgX=lastX+dx; imgY=lastY+dy; updateTransform();
    }else if(e.touches.length===2){
      const dist=getDist(e); if(startDist>0){ scale=Math.min(5,Math.max(1,lastScale*dist/startDist)); updateTransform(); }
    }
  },{passive:true});
  img.addEventListener('touchend',()=>{lastX=imgX; lastY=imgY; lastScale=scale;});

  /* æ’®å½± */
  async function doShoot(){
    const label=(currentLabel||'æœªæŒ‡å®š').trim();
    try{
      const safe=s=>s.replace(/[\\/:*?"<>|]/g,'_');
      const blob=await captureFrame();
      const extra=(suffixInput.value||'').trim();
      const suffix=extra?('_'+safe(extra)):'';
      const filename=safe(`${label}${suffix}_${ts()}.jpg`);

      const how=await saveBlob(blob, filename);

      if(previewUrl) URL.revokeObjectURL(previewUrl);
      previewUrl=URL.createObjectURL(blob); img.src=previewUrl;
      resetPreviewTransform();

      if(label && label!=='æœªæŒ‡å®š' && label!=='-'){
        const btn=[...nums.children].find(x=>(x.dataset.label && x.dataset.label===label)||(!x.dataset.label && x.textContent===label));
        if(btn) btn.classList.add('shot');
      }

      if(how==='opfs' || how==='fs') toast('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†','ok');
      else if(how==='download')       toast('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹','ok');
      else                            toast('ä¿å­˜ã—ã¾ã—ãŸ','ok');

      if(!rightOpen){openRight(true); setTimeout(()=>openRight(false),1000);}
    }catch(e){
      toast(e.message||'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ','err');
    }finally{
      ensureStreamAlive();
    }
  }
  shootBtn.addEventListener('click',doShoot);

  /* ãƒ‰ãƒ­ãƒ¯ */
  function openLeft(open){ leftOpen=!!open; ldrawer.classList.toggle('open', leftOpen); }
  function openRight(open){ rightOpen=!!open; rdrawer.classList.toggle('open', rightOpen); }
  lToggle.addEventListener('click',()=>openLeft(!leftOpen));
  rToggle.addEventListener('click',()=>openRight(!rightOpen));
  lClose.addEventListener('click',()=>openLeft(false));
  rClose.addEventListener('click',()=>openRight(false));
  resetMarkBtn.addEventListener('click',()=>[...nums.children].forEach(x=>x.classList.remove('shot')));

  /* éŸ³é‡å°ã§æ’®å½±ï¼ˆå¯¾å¿œç«¯æœ«ã®ã¿ï¼‰ */
  window.addEventListener('keydown',e=>{
    if(e.key==="AudioVolumeDown"||e.key==="VolumeDown"||e.code==="VolumeDown"){ e.preventDefault(); doShoot(); }
  });

  /* å¾©å¸°æ™‚ã®é»’ç”»é¢å¯¾ç­– */
  window.addEventListener('focus',ensureStreamAlive);
  document.addEventListener('visibilitychange',()=>{ if(!document.hidden) ensureStreamAlive(); });

  await startCamera();
})();
</script>
